<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.blog.mapper.ArticleMapper">
    
    <!-- 归档文章查询 -->
    <select id="selectArchiveArticles" resultType="com.blog.entity.Article">
        SELECT DISTINCT a.* FROM articles a
        <if test="tagIds != null and tagIds.size() > 0">
            INNER JOIN article_tags at ON a.id = at.article_id
        </if>
        <where>
            a.status = 1
            <if test="keyword != null and keyword != ''">
                AND (a.title LIKE CONCAT('%', #{keyword}, '%') 
                OR a.summary LIKE CONCAT('%', #{keyword}, '%')
                OR a.content LIKE CONCAT('%', #{keyword}, '%'))
            </if>
            <if test="tagIds != null and tagIds.size() > 0">
                AND at.tag_id IN
                <foreach collection="tagIds" item="tagId" open="(" separator="," close=")">
                    #{tagId}
                </foreach>
            </if>
        </where>
        <if test="tagIds != null and tagIds.size() > 0">
            GROUP BY a.id
            HAVING COUNT(DISTINCT at.tag_id) = #{tagIds.size()}
        </if>
        ORDER BY
        <choose>
            <when test="sortBy == 'date-asc'">
                a.published_at ASC
            </when>
            <when test="sortBy == 'views'">
                a.view_count DESC
            </when>
            <when test="sortBy == 'likes'">
                a.like_count DESC
            </when>
            <otherwise>
                a.published_at DESC
            </otherwise>
        </choose>
    </select>
    
</mapper>
