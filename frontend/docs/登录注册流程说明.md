# 登录注册流程说明

## 已完成的工作

### 1. 移除 Mock 数据
- 删除了所有 Mock 用户数据
- 所有接口都对接真实后端 API

### 2. 更新 API 接口

#### 认证接口 (`src/api/auth.ts`)
- `login()` - 登录接口
- `register()` - 普通注册（不需要验证码）
- `registerWithCode()` - 验证码注册
- `logout()` - 登出接口
- `getCurrentUser()` - 获取当前用户信息

#### 邮件接口 (`src/api/email.ts`)
- `sendVerificationCode()` - 发送验证码

### 3. 配置请求拦截器

在 `src/api/request.ts` 中：
- 自动添加 Authorization token
- 统一处理响应数据
- 401 自动跳转登录
- 错误信息统一提示

### 4. 配置开发代理

在 `vite.config.ts` 中配置了代理：
```typescript
proxy: {
  '/api': {
    target: 'http://localhost:8080',
    changeOrigin: true
  }
}
```

### 5. 环境变量配置

- `.env.development` - 开发环境
- `.env.production` - 生产环境

## 完整流程

### 注册流程

1. 用户访问 `/register` 页面
2. 输入邮箱，点击"获取验证码"
3. 前端调用 `POST /api/email/send-code?email=xxx`
4. 后端发送验证码到邮箱
5. 用户输入验证码、密码等信息
6. 点击注册，调用 `POST /api/auth/register-with-code`
7. 注册成功，跳转到首页

### 登录流程

1. 用户点击登录按钮，打开登录模态框
2. 输入邮箱和密码
3. 点击登录，调用 `POST /api/auth/login`
4. 后端验证成功，返回 token 和用户信息
5. 前端保存 token 到 localStorage
6. 更新 Pinia store 状态
7. 关闭模态框，显示登录成功提示

### 登出流程

1. 用户点击登出按钮
2. 调用 `POST /api/auth/logout`
3. 清除 localStorage 中的 token 和用户信息
4. 清除 Pinia store 状态
5. 跳转到首页

### 自动登录

1. 页面加载时，调用 `initUser()`
2. 从 localStorage 读取 token
3. 调用 `GET /api/auth/current` 验证 token
4. 如果有效，恢复用户登录状态
5. 如果无效，清除本地数据

## API 数据格式

### 登录请求
```json
POST /api/auth/login
{
  "email": "user@example.com",
  "password": "123456"
}
```

### 登录响应
```json
{
  "code": 200,
  "message": "操作成功",
  "data": {
    "token": "xxx",
    "user": {
      "id": 1,
      "email": "user@example.com",
      "name": "用户名",
      "avatar": "头像URL",
      "role": 0
    }
  }
}
```

### 注册请求
```json
POST /api/auth/register-with-code
{
  "email": "user@example.com",
  "code": "123456",
  "password": "123456",
  "name": "用户名"
}
```

### 发送验证码
```
POST /api/email/send-code?email=user@example.com
```

## 测试步骤

### 1. 启动后端
```bash
cd backend
mvn spring-boot:run
```

### 2. 配置数据库和邮箱
- 执行 `database/schema.sql`
- 配置 `application.yml` 中的数据库和邮箱

### 3. 启动前端
```bash
cd frontend
npm run dev
```

### 4. 测试注册
1. 访问 http://localhost:5173/register
2. 输入邮箱，点击获取验证码
3. 查收邮件，输入验证码
4. 填写其他信息，点击注册
5. 查看是否注册成功

### 5. 测试登录
1. 访问 http://localhost:5173
2. 点击登录按钮
3. 输入注册的邮箱和密码
4. 点击登录
5. 查看是否登录成功

## 注意事项

1. **CORS 配置**：后端已配置 CORS，允许跨域请求
2. **Token 存储**：使用 localStorage 存储，刷新页面不会丢失
3. **错误处理**：所有错误都会通过 Message 组件提示
4. **自动跳转**：401 错误会自动清除登录状态
5. **验证码限制**：5 分钟内只能发送一次

## 后续优化建议

1. 添加 Token 刷新机制
2. 添加记住密码功能
3. 添加第三方登录（GitHub、Google 等）
4. 添加密码强度检测
5. 添加图形验证码防止机器人
6. 添加登录日志记录
